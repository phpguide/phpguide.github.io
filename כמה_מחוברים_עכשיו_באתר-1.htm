<!DOCTYPE html>
<html lang="he" itemscope="" itemtype="http://schema.org/Article" ng-app="phpg">
<head>
<base href="https://phpguide.co.il/">
<meta charset="utf-8">
<meta name="description" content="אופן הספירה של כמות הגולשים המחוברים שצופים כרגע לאתר.">
<meta name="keywords" content="מחוברים, אונליין, עכשיו באתר, מחוברים כעט">
<meta name="author" content="intval">
<link rel="shortcut icon" href="static\images\favicon-1.ico">
<!--[if lt IE 9]><script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
<link rel="stylesheet" type="text/css" href="static\styles\allstyles.compiled.css">
<title>כמה מחוברים עכשיו באתר?</title>
<meta itemprop="name" content="כמה מחוברים עכשיו באתר?">
<meta itemprop="description" content="אופן הספירה של כמות הגולשים המחוברים שצופים כרגע לאתר.">
</head>
<body dir='rtl' class="article"><script type="text/javascript">window.phpgstate={"post":{"id":"61","rating":"30","hasCurrentUserVoted":false}};</script>
<div class='page-container'>
<section id='header'>
<div class="topRowHolder">
<a class="logo" href="index-3.htm"><img src="static\images\logo.jpg"></a>
<nav class="main">
<ul>
<li><a href="index-3.htm" class="active">פוסטים</a></li>
<li><a href="qna-1.htm">פורום</a></li>
</ul>
<div class="clear"></div>
</nav> <div class="clear"></div>
</div>
</section>  
<div class="layout-holder">
<section id="content">
<h1 class='content-title'><span></span>כמה מחוברים עכשיו באתר?</h1>
 
<div id="content-publishing-info">
<div class="right">intval, </div>
<div class="right">&nbsp;<time datetime="2011-01-22T09:43:40+02:00" dir="rtl">22 לינואר 2011</time></div>
<div class="clear"></div>
</div>
 
<article>
<header>
<div class="right post-image">
<img src="static\images\pixel.png" title="http://www.piccresource.com/online-classes/file.php/1/pronline.jpg" alt="כמה מחוברים עכשיו באתר?">
</div>
<div class="right post-content">
למה נכון לומר שיש בדיוק אפס גולשים און ליין?<br>איך בכל זאת יודעים כמה גולשים עכשיו באתר ואיך עושים את זה נכון <br>
</div>
<div class="clear"></div>
</header>
<br><br>
שאלה שמעניינת כל מנהל אתרים היא השאלה הנצחית: כמה אנשים גולשים לו עכשיו באתר. <br>ראשית יש להבין שתמיד התשובה היא <strong>אפס</strong>, ולא בגלל שהאתר לא כזה שווה, אלה בגלל מבנה הרשת. כאשר אתם גולשים לאתר כלשהו, הדפדפן שלכם שולח לשרת בקשה להביא לו עמוד כלשהו, לדוגמה index.html. השרת מקבל את הבקשה, מבצע את הבקשה בחלקי שניות, מחזיר לדפדפן את העמוד המבוקש וסוגר את החיבור איתו. לאחר שהשרת החזיר לדפדפן את הדף - הם לא מחוברים יותר ביחד.<br>בצעו ניסוי קטן. הוציאו עכשיו את כבל הרשת מהמחשב שלכם. אתם עדיין רואים את העמוד הזה? אתם כרגע באתר? איך אתם יכולים להיות כרגע מחוברים לאתר אם אתם אפילו <span class="underline">לא מחוברים לאינטרנט</span>?<br><br><br><h3>מי נחשב לגולש כרגע באתר</h3><br>הבקשה של הדפדפן לשרת להביא את הדף הזה הייתה לפני שניות בודדות. האם זה נחשב שברגע זה אתם גולשים באתר? קראתם את המשפט הזה ועברו עוד כמה שניות, אתם עדיין באתר? לשרת אין על זה שמץ של מושג, הרי ניתקתם את קבל הרשת שלכם. עלינו לקבוע מסגרת זמן שכל הבקשות בה יחשבו כגולשים באתר, וכל הבקשות הישנות יותר לא יחשבו כגולשים באתר.<br><br>לדוגמה אם מישהו שלח בקשה לעמוד כלשהו אתמול בערב ומאז לא שלח בקשות חדשות, האם ייחשב כגולש מחובר באתר? ואם זה היה לא אתמול בערב, אלה לפני 5 שעות? ו-3 שעות? שעה? אם משתמש עשה פעולה אחרונה כלשהי באתר לפני שעה (טען עמוד כלשהו) ומאז לא עשה יותר שום דבר, האם הוא נחשב למחובר כרגע?<br><br>מקובל לקבוע מסגרת זמן זו ל<strong>שלוש דקות</strong>. משתמש שלא עשה שום דבר בשלוש דקות האחרונות באתר - כנראה כבר עזב. אתם יכולים לבחור מסגרת אחרת, אם המשתמשים קוראים עמודים באתר שלכם עם מילון או שיש לכם עמודים עם תוכן רב. <br>פורומים עם הרבה הודעות בעמוד לוקחים מסגרת של 10 דקות. כל מי שלא עשה שום פעולה (לא שלח שום בקשה לשרת) ב-10 דקות האחרונות כבר לא מחובר. <br><br><h3>נרשום מתי הייתה הפעולה האחרונה של כל גולש</h3><br>החישוב של כמות האנשים המחוברים מתבצעת לפי זמן הפעולה האחרון שלהם. כדי שנוכל לעשות את החישובים המתאימים - אנחנו חייבים לרשום את זמני הפעולה של כל גולש במסד וכאן יהיה לנו פיצול כלשהו. קיימים שני סוגי אתרים ולשניהם הקוד יהיה מעט שונה: <br>אתרים עם משתמשים רשומים, כמו פורומים, ואתרים בלי הרשמה, כמו האתר הזה למשל.<br><br><h5>טבלת רישום באתרים בלי הרשמה</h5><br>אנחנו צריכים להבדיל בין גולש לגולש, כי אין להם שמות שונים שנרשמו איתם. את ההבדלה נבצע באמצעות כתובת ה-IP, מזהה ייחודי של גולש ברשת שניתן לו על ידי ספק האינטנט בעת ההתחברות. שימו לב, ה-IP אינו קבוע לכל החיים ואצל ספקיות רבות הוא משתנה עם כל הפעלה מחדש של המודם. <br><br>ניצור טבלה שאליה נרשום את כל המשתמשים. <br>הטבלה תורכב בדיוק משני שדות. ה-ip והזמן שהתרחשה בו הפעולה האחרונה מכתובת ip זו.<br><div class="php codeblock">CREATE TABLE `online` <span class="br0">&#40;</span><br>
`ip` VARCHAR<span class="br0">&#40;</span> <span class="nu0">15</span> <span class="br0">&#41;</span> NOT <span class="kw4">NULL</span> <span class="sy0">,</span><br>
`<span class="kw3">time</span>` TIMESTAMP ON UPDATE CURRENT_TIMESTAMP NOT <span class="kw4">NULL</span> <span class="kw1">DEFAULT</span> CURRENT_TIMESTAMP <span class="sy0">,</span><br>
PRIMARY <span class="kw3">KEY</span> <span class="br0">&#40;</span> `ip` <span class="br0">&#41;</span><br>
<span class="br0">&#41;</span> ENGINE <span class="sy0">=</span> MYISAM CHARACTER SET utf8 COLLATE utf8_general_ci<span class="sy0">;</span></div><br><br><br><h5>באתרים עם הרשמה</h5><br>כיוון שלכל משתמש יש לנו שם משתמש משלו נכניס לטבלת המשתמשים users עוד עמודה נוספת ונרשום בה את זמן הפעולה האחרונה.<br><div class="php codeblock">ALTER TABLE `userstable` ADD `<span class="kw3">time</span>` TIMESTAMP <br>
ON UPDATE CURRENT_TIMESTAMP NOT <span class="kw4">NULL</span> <span class="kw1">DEFAULT</span> CURRENT_TIMESTAMP</div><br><br><h4>הקוד</h4><br>הקוד לרישום הפעולה האחרונה בטבלה יראה כך:<br><div class="php codeblock"><span class="re0">$ip</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'REMOTE_ADDR'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span><br>
<span class="kw3">mysql_query</span><span class="br0">&#40;</span><span class="st0">&quot;INSERT INTO `online` (`ip`,`time`) VALUES ('<span class="es4">$ip</span>',CURRENT_TIMESTAMP)<br>
ON DUPLICATE KEY UPDATE `time` = CURRENT_TIMESTAMP&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div><br>תחילה נקבל את כתובת ה-ip הייחודית של הגולש למשתנה, אחר כך נכניס אותו לטבלה.<br>אם הוא כבר קיים בטבלה - לא נכניס אותו שוב, אלה רק נעדכן את זמן הפעולה האחרון שלו.<br>הפקודה on duplicate key -- update אומרת למסד שבמקרה וכבר קיימת רשומה עם ip כזה, יש לעשות עידכון במקום ההכנסה המחודשת.<br><br>לאתרים עם הרשמה הכל יותר פשוט. צריך רק לעדכן את זמן הפעולה האחרון של המשתמש<br><div class="php codeblock"><span class="re0">$user</span> <span class="sy0">=</span> <span class="kw3">mysql_real_escape_string</span><span class="br0">&#40;</span><span class="sy0">...</span><span class="br0">&#41;</span><span class="sy0">;</span><br>
<span class="kw3">mysql_query</span><span class="br0">&#40;</span><span class="st0">&quot;UPDATE `userstable` SET `online` = CURRENT_TIMESTAMP <br>
WHERE `user`='<span class="es4">$user</span>'&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div><br><br><h5>איפה להפעיל את הקוד הזה</h5><br>את הקוד הזה יש להפעיל בכל בקשה של המשתמש לשרת. כל ריענון, כל טעינה.<br>הדרך הכי טובה היא לרשום את הקוד הזה בקובץ counter.php ולעשות לו require_once כל טעינה. באתרים עם הרשמה את הקוד הזה אפשר להפעיל רק אחרי שהמשתמש הזדהה, אחרת אין לנו את מי לעדכן.<br><br><h3>ספירת מחוברים</h3><br>עכשיו יש לנו טבלה עם זמני הפעולה האחרונים של כל משתמש. נשאר רק לספור כמה מהם היו פעילים בשלוש דקות האחרונות ויהיה לנו מספר. הקוד לספירה יראה ככה:<br><div class="php codeblock"><span class="re0">$query</span> <span class="sy0">=</span> <span class="kw3">mysql_query</span><span class="br0">&#40;</span><span class="st0">&quot;SELECT COUNT(*) FROM `online` <br>
WHERE `time` &gt; DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 3 MINUTE)&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span><br>
<span class="re0">$online</span> <span class="sy0">=</span> <span class="kw3">mysql_result</span><span class="br0">&#40;</span><span class="re0">$query</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span></div> <br><br>השאילתה סופרת את כמות השורות שבהם זמן הפעולה האחרונה גדול מ (עכשיו פחות 3 דקות).<br>זהו בעצם מספר הגולשים שכרגע נמצאים אונליין באתר. את המספר הזה אתם יכולים להציג איפהשו באתר, <a href="מציירים_תמונות_עם_php-1.htm">לצייר על כפתור יפה</a> ולהראות בתחתית העמוד או סתם להשתמש בזה לצורכי סטטיסטיקה. </article>
<br><br>
<div class="info_box" data-ng-controller="PostViewCtrl">
<div class="right left-spaced">
<img src="static\images\pixel.png" title="http://www.gravatar.com/avatar/29c688bfdc6cb0d2e6dea24ccdc7beb1?s=16&r=g&d=monsterid" alt="intval">
<a>intval</a>
</div>
<div class="clear"></div>
</div>
<div>
</div>
<section class="comments" id='post_comments'>
<h2>תגובות לכתבה:</h2>
<a id="comment3"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>23/01/2011 15:44</span><br>
כל הכבוד! אחלה מדריך :) רק תתקן את השגיאת כתיב ״לצורחי״</div>
<a id="comment4"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>26/01/2011 16:33</span><br>
מדריך ממש נחמד, כל הכבוד!</div>
<a id="comment15"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>01/03/2011 21:52</span><br>
מדריך מצוין וברור כמו כל התכנים באתר, כל הכבוד.<br>
<br>
שתי הערות<br>
<br>
מומלץ לאנדקס את TIME ופעם ביום למחוק מהטבלה רשומות שקטנות מעכשיו פחות קבוע זמן (3 דקות), אחרת תהיה לנו טבלה מאוד עמוסה לאחר מספר ימים/חודשים תלוי במספר הכניסות לאתר.<br>
<br>
לא מספיק לספור כתובות אייפי מכיוון שכאשר המשתמשים שלך גולשים מבתי קפה או עסק וכדומה אז יש לך מספר רב של משתמשים עם אותה כתובת אייפי ולכן הספירה שלך לא נכונה.<br>
<br>
לכן מומלץ לזהות משתמש לפי אייפי ועוגיה עם עירך חד חד ערכי ולא רק לפי אייפי.</div>
<a id="comment16"></a>
<div class="blog-comment">
<span class='comment-author'>eshk</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>02/03/2011 22:10</span><br>
נחמד מאוד!<br>
לא ראיתי שיטה כזאת שמבוצעת ע&quot;י מסד</div>
<a id="comment30"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>22/03/2011 19:08</span><br>
שיטה נחמדה , באמת אבל יש דרך קיצור !!! דרך אגב אני כולה בת 12 ככה ש ... נחמד שאני יודת יותר ממשהו .. D :</div>
<a id="comment31"></a>
<div class="blog-comment">
<span class='comment-author'>intval</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>22/03/2011 21:25</span><br>
אשמח אם תספרי על הדרך קיצור לכולנו וכל הכבוד.</div>
<a id="comment97"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>27/04/2011 13:57</span><br>
יופי של מדריך.<br>
לומד הרבה מאתרך, המשך כך.</div>
<a id="comment123"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>13/05/2011 13:31</span><br>
תודה רבה לך המדריך מאוד עזר לי<br>
המשך כך</div>
<a id="comment216"></a>
<div class="blog-comment">
<span class='comment-author'>Michael</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>16/06/2011 13:41</span><br>
מעניין אותי למה אתה עושה escape לאיפי, אם בלתי אפשרי לערוך אותו?</div>
<a id="comment217"></a>
<div class="blog-comment">
<span class='comment-author'>עידו</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>16/06/2011 13:49</span><br>
יפה מאוד :]<br>
תמשיך להכין מדריכים מפורטים!</div>
<a id="comment226"></a>
<div class="blog-comment">
<span class='comment-author'>intval</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>19/06/2011 19:00</span><br>
אני עושה escape גם לip <br>
א. מתוך הרגל לעשות הברחה לכל כל הנתונים שאני מכניס למסד<br>
ב. ליתר בטחון, אם השרת יחזיר במקום IPv6 ערך מוזר כלשהו. לא שקרה לי היי פעם, אבל אני עדיין לא מאמין לגמרי בדרך שבה השרתים nginx, apache מסתדרים עם ipV6</div>
<a id="comment493"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>30/07/2011 11:47</span><br>
יפה!</div>
<a id="comment679"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>28/08/2011 12:33</span><br>
אי אפשר לעשות פשוט כל עוד יש סיישן לסמן בטבלה <br>
1 ואם אין סיישן לסמן 0 ואז זה יוריד ויעלה את מס&apos; המחוברים לפי שאילתה?. כמובן שזה רק באתרים עם הרשמה <br>
נכון לעשות דבר כזה?</div>
<a id="comment680"></a>
<div class="blog-comment">
<span class='comment-author'>intval</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>28/08/2011 13:19</span><br>
איך אתה תדע אם &quot;יש סשן או אין סשן יותר&quot; ?</div>
<a id="comment681"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>28/08/2011 13:20</span><br>
מה זאת אומרת הוא בודק בכל דף אם קיים הסיישן <br>
ועוד דבר יש לי בעיה כזאת <br>
arning: mysql_result() [function.mysql-result]: Unable to jump to row 0 on MySQL result index 10 in</div>
<a id="comment682"></a>
<div class="blog-comment">
<span class='comment-author'>intval</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>28/08/2011 13:28</span><br>
שאלות לפורום.<br>
הבעיה היא שאי אפשר לטפוס את הרגע שבו &quot;הסשן נעלם&quot;. שהוא גם לא נעלם, אלה רק 25 דקות אחרי השימוש האחרון שלו. ואף אחד גם לא מודיע לך מתי היה השימוש האחרון שלו.</div>
<a id="comment683"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>28/08/2011 13:38</span><br>
מה זאת אומרת סיישן לא נעלם ד&quot;א אחלה אתר אלכס</div>
<a id="comment684"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>28/08/2011 15:22</span><br>
דרך נוספת שמצאתי לבדוק אם מחובר או לא בשאילתה אחרת $query = mysql_query(&quot;SELECT `online` FROM `users` WHERE `id`=&apos;&quot;.$_GET[&apos;id&apos;].&quot;&apos;&quot;);<br>
$online = mysql_fetch_assoc($query);<br>
if($online[&apos;online&apos;]&gt;(time()-320))<br>
echo &quot;מחובר&quot;;<br>
else <br>
echo &quot;לא מחובר&quot;;</div>
<a id="comment685"></a>
<div class="blog-comment">
<span class='comment-author'>intval</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>28/08/2011 18:06</span><br>
זה אותו דבר, רק שבמקום שהמסד יעשה את החישובים - PHP עושה אותם. ההבדל הוא שהמסד עושה את החישובים האלה מהר יותר ובפחות זיכרון.</div>
<a id="comment686"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>28/08/2011 18:29</span><br>
אוקיי תודה אלכס</div>
<a id="comment849"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>10/10/2011 03:19</span><br>
תודה!</div>
<a id="comment1368"></a>
<div class="blog-comment">
<span class='comment-author'>אנונימי</span><span dir="rtl">&nbsp;</span>
<span dir="ltr" class='comment-date'>27/02/2012 18:24</span><br>
תודה</div>
</section>
</section>  
<section id="sidebar">
<section id="search_box">
<form method="get" action="http://www.google.co.il/search" id="search_form">
<input type="hidden" name="hl" value="iw">
<input type="checkbox" name="sitesearch" style="display:none" value="https://phpguide.co.il" checked="">
<input type="text" class="search_form" placeholder="חיפוש" name="q" id="search_field">
<input type="submit" value="" title="לחפש">
</form>
</section>
<style>.staticSidebarPageLinks a{color:#e85a2d;font-weight:bold;text-decoration:underline}</style>
<div class='rblock staticSidebarPageLinks' style="padding:0 -50px; width:100%; background: white;">
<a href="page_mvcebook.html" title="למד איך עובד MVC" onclick="Analytics.track('Promotion', 'click', 'GoToLanding', 'mvcebook-sidebar-banner1');">
ספר חינם על MVC
</a>
שאתה הולך להוריד כי אם אתה רוצה ללמוד על ארגון קוד יעיל ומודרני באתרים כמו זה או פייסבוק או כי כולם אוהבים להוריד דברים איכותיים בחינם מהאינטרנט
<br><br>
<a href='page_oopbook.html'>
ספר הלימוד - תכנות מונחה עצמים מאפס
</a>
שסוף סוף ילמד אותך פיתוח מונחה עצמים נכון בצורה פשוטה, יענה על כל השאלות ויכין אותך לרעיונות עבודה.
<br><br>
<a href='page_phpunit.html'>
קורס בדיקות יחידה phpunit
</a>
שיעזור לך להקטין בחצי את כמות הבאגים, את כאב הראש והזמן המבוזבז על פתירתם
<br><br>
<a href='page_mysqlinteractive.html'>
קורס mysql אינטרקטיבי
</a>
שיייקח אותך צעד אחר צעד למומחה שאילתות mysql לייב
<br><br><br>
<small>האתר ב-readonly
<br>
תודה לכל מי שתרם, ענה, שאל, כתב, לימד ועזר במשך השנים <br>
orelbey, splash, raslin, cayce, iiddaannyy, michael, kingyes, ilikeme, itamarhadad, iosolidar, jbstyle<br>
- alex@הדומיין הזה
</small>
</div>
</section>
</div>
<footer id='footer'>
</footer>
</div>  
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.6/angular.min.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.6/angular-resource.min.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.6/angular-cookies.min.js"></script>
<script type="text/javascript" src="assets\c2224fc8\jquery.min.js"></script>
<script type="text/javascript" src="static\scripts\scripts.compiled.js"></script>
<script type="text/javascript" src="static\scripts\plugins.js"></script>
<script type="text/javascript" src="static\scripts\ui.js"></script>
<script type="text/javascript" src="static\scripts\analytics.js"></script>
</body>
</html>
